% run Friedman and follow up sign rank tests on ratings data


% for each task
for task_ind = [1 2 3] % preference, detail, 3d
    
    % load data generated by barplot_withIndividual, user's median rating across all scenes
    % each row is a user
    % each column is a condition

    col_names = {'Avg','Global','Local','zDichoptic','Proper','High','Low','eDichoptic'};
    
    disp('--------------------------------------')
    if task_ind == 1
        disp('currently analyzing preference task')
        load('./usermedians_preference.mat');
    elseif task_ind == 2
        disp('currently analyzing detail task')
        load('./usermedians_detail.mat');
    elseif task_ind == 3
        disp('currently analyzing 3d task')
        load('./usermedians_depth.mat');
    end
    
    
    % run FRIEDMAN test comparing among zhang and exposure conditions separately
    
    [zhang_p,  zhang_t,    ~] = friedman(all(:,1:4),1,'off');
    [expo_p,   expo_t,     ~] = friedman(all(:,5:8),1,'off');
    zhang_chisq = zhang_t{2,5};
    expo_chisq  = expo_t{2,5};
    
    fm_text = {strcat('zhang Friedman chi2 =',num2str(zhang_chisq),' & p =',num2str(zhang_p));
        strcat('expo Friedman chi2 =',num2str(expo_chisq),' & p =',num2str(expo_p))};
    disp(fm_text);
    
    % is there a difference between the dichoptic conditions and the other conditions?
    % run WILCOXON paired sign rank test
    
    % for each dichoptic condition
    for dichoptic = [4,8]
        
        % get ratings for this dichoptic condition
        xdata = all(:,dichoptic);
        
        % set up for comparisons
        if dichoptic == 4       % zDichoptic, pair with Avg, Local, Global
            pair = [1 2 3];     % indices of non-dichoptic comparisons
        elseif dichoptic== 8    % eDichoptic,pair with Proper, High, Low
            pair = [5 6 7];     % indices of non-dichoptic comparisons
            
        end
        
        % initialize vector of pvalues and zstatistics
        result.p = [];
        result.z = [];
        
        % for each desired paired comparison
        for col = pair
            
            text = ['dichoptic condition ' col_names{dichoptic} ' vs comparison ' col_names{col}];
            disp(text)
            
            % get ratings for  the comparison condition
            ydata = all(:,col);
            
            % run test, using z test statistic
            [p,~,stats] = signrank(ydata,xdata,'method','approximate');
            
            % store
            result.p = [result.p p];
            result.z = [result.z stats.zval];
        end
        
        % display results
        % note that in the manuscript, p values are corrected for multple
        % comparisons using a false discovery rate of 0.05
        disp('list of z values')
        disp(result.z)
        disp('list of p values')
        disp(result.p)
        
    end
    
end








